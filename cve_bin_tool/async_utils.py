# pylint: disable=too-many-arguments
""" Utility classes for the CVE Binary Tool """
import asyncio
import glob
import os
import shutil
import sys
import tempfile

from async_files.utils import async_wraps

from .util import inpath


def get_event_loop():
    try:
        loop = asyncio.get_event_loop()
    except RuntimeError:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
    if sys.platform.startswith("win"):
        if isinstance(loop, asyncio.SelectorEventLoop):
            loop = asyncio.ProactorEventLoop()
            asyncio.set_event_loop(loop)
    return loop


def run_coroutine(coro):
    loop = get_event_loop()
    aws = asyncio.ensure_future(coro)
    result = loop.run_until_complete(aws)
    return result


async def aio_run_command(args):
    process = await asyncio.create_subprocess_exec(
        *args,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    stdout, stderr = await process.communicate()
    return stdout, stderr  # binary encoded


aio_rmdir = async_wraps(shutil.rmtree)
aio_rmfile = async_wraps(os.remove)
aio_unpack_archive = async_wraps(shutil.unpack_archive)
aio_glob = async_wraps(glob.glob)
aio_mkdtemp = async_wraps(tempfile.mkdtemp)
aio_makedirs = async_wraps(os.makedirs)
aio_inpath = async_wraps(inpath)
